name: Issue to Post

on:
  issues:
    types: [labeled]

jobs:
  convert-issue:
    if: github.event.label.name == 'publish'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check allowlist
      id: check-allowlist
      run: |
        ALLOWLIST=$(cat config/allowlist.json)
        AUTHOR="${{ github.event.issue.user.login }}"
        if echo "$ALLOWLIST" | jq -e ".[] | select(. == \"$AUTHOR\")" > /dev/null; then
          echo "author_allowed=true" >> $GITHUB_OUTPUT
        else
          echo "author_allowed=false" >> $GITHUB_OUTPUT
        fi

    - name: Convert issue to post
      if: steps.check-allowlist.outputs.author_allowed == 'true'
      run: |
        ISSUE_NUMBER=${{ github.event.issue.number }}
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        AUTHOR="${{ github.event.issue.user.login }}"

        # Generate filename
        DATE=$(date +%Y-%m-%d)
        SLUG=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
        FILENAME="content/posts/$DATE-$SLUG.md"

        # Create frontmatter
        cat > "$FILENAME" << EOF
        ---
        title: "$ISSUE_TITLE"
        date: "$DATE"
        description: "Community contribution from GitHub issue #$ISSUE_NUMBER"
        tags: ["community", "contribution"]
        slug: "$SLUG"
        author: "$AUTHOR"
        ---

        $ISSUE_BODY
        EOF

        echo "Created post: $FILENAME"

    - name: Move to drafts (moderation needed)
      if: steps.check-allowlist.outputs.author_allowed == 'false'
      run: |
        mkdir -p content/posts/drafts
        ISSUE_NUMBER=${{ github.event.issue.number }}
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        AUTHOR="${{ github.event.issue.user.login }}"

        # Generate filename
        DATE=$(date +%Y-%m-%d)
        SLUG=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
        FILENAME="content/posts/drafts/$DATE-$SLUG.md"

        # Create frontmatter
        cat > "$FILENAME" << EOF
        ---
        title: "$ISSUE_TITLE"
        date: "$DATE"
        description: "Community contribution from GitHub issue #$ISSUE_NUMBER - pending moderation"
        tags: ["community", "contribution", "draft"]
        slug: "$SLUG"
        author: "$AUTHOR"
        ---

        $ISSUE_BODY
        EOF

        echo "Created draft post: $FILENAME"

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add content/posts/
        git diff --quiet && git diff --staged --quiet || git commit -m "Add post from issue #${{ github.event.issue.number }}"
        git push

    - name: Close issue
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… Your post has been processed and added to the content queue. It will be published according to the publishing schedule.'
          })
          github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed'
          })